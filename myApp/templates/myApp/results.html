{% extends 'myApp/base.html' %}
{% block content%}

<div class="container">
    <div class="row p-0 m-0">

        <div class="col mt-5 d-flex justify-content-center align-items-center">
            <div class="table-responsive border border-warning" style="padding: 10px 10px 10px 10px;">
                <div>
                    <!-- video trigger modal -->
                    <img class="img-responsive img-thumbnail" data-toggle="modal" data-target="#modal-video" width="500"
                        height="320" src="" id="video-feed">
                    <!-- Modal -->
                    <div class="modal fade" id="modal-video" tabindex="-1" aria-labelledby="videoModalLabel"
                        aria-hidden="true">
                        <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title" id="videoModalLabel">Video</h5>
                                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                        <span aria-hidden="true">&times;</span>
                                    </button>
                                </div>
                                <div class="modal-content p-3">
                                    <img src="" id="stream" class="img-fluid">
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-primary" data-dismiss="modal">Close</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div>
                    <h5 class="text-center p-1 mt-2 mb-3 bg-danger text-white">Fatigue Analysis Results</h5>
                    <strong id="gaitResult" class="d-flex justify-content-center">Waiting for the result of Fatigue
                        Analysis Server...</strong>

                    <div class="table-responsive border border-warning" style="padding: 10px 10px 10px 10px;">
                        <table id="table" class="table text-center table-striped table-dark table-bordered">
                            <thead>
                                <tr>
                                    <th scope="col">Worker ID</th>
                                    <th scope="col">Worker Name</th>
                                    <th scope="col">Result</th>
                                   


                                </tr>
                                <tr>
                                    <td id="workerId">Proccesing..</td>
                                    <td id="workerName">Proccesing..</td>
                                    <td id="workerResult">Proccesing..</td>
                                </tr>
                            </thead>
                            <tbody id="tbody">
                            </tbody>
                        </table>

                    </div>
                    <div class="d-flex justify-content-center">
                        <div id="spinner1" class="spinner-border text-dark my-2" role="status" aria-hidden="true"
                            style="display: block;"></div>
                        <!-- <div class="d-flex justify-content-center">
                            <p>Task ID: {{ task_id }}</p>
                            <p>Status: <span id="status">{{ status }}</span></p>
                        </div> -->

                    </div>
                </div>
                <!-- <div>
                        <button class="btn btn-primary mt-3" type="button" data-toggle="collapse" data-target="#collapse-silhouette" aria-expanded="true" aria-controls="collapseExample">
                            Silhouettes
                        </button>
                        <button class="btn btn-primary mt-3 ml-2" type="button" data-toggle="collapse" data-target="#collapse-image" aria-expanded="false" aria-controls="collapseExample2">
                            Alpha Images
                        </button>
                    </div> -->
            </div>
        </div>

        <!-- <div class="col-6 mt-5">
                <div class="table-responsive border border-warning" style="padding: 10px 10px 10px 10px;">
                    <h5 class="text-center p-1 mb-1 bg-success text-white">Rank-6 of Gait Similarity Probability</h5>
                    <table id="table" class="table text-center table-striped table-dark table-bordered">
                        <thead>
                            <tr>
                                <th scope="col">Rank</th>
                                <th scope="col">Name</th>
                                <th scope="col">Vid</th>
                                <th scope="col">Dist</th>
                                <th scope="col"><i>Prob</i><sub>(<i>simi</i>)</sub> (%)</th>
                            </tr>
                        </thead>
                        <tbody id="tbody">
                        </tbody>
                    </table>
                    <div class="d-flex justify-content-center mb-2">
                        <div id="spinner2" class="spinner-border text-dark my-2" role="status" aria-hidden="true" style="display: block;"></div>
                    </div>
                </div>
            </div> -->

    </div>




</div>

<footer>
    <div class="row mt-5 mb-2">
        <div class="col">
            <p class="text-center"> Â© Copyright 2024 - Smart Fatigue Analysis System using Gait Sequence.</p>
        </div>
    </div>
</footer>
<script>
    // WebSocket connection
    const socket = new WebSocket('ws://' + window.location.host + '/ws/video-feed/');

    // When a new message is received
    socket.onmessage = function(event) {
        // Update the <img> element with the received frame data
        const imgElement = document.getElementById('video-feed');
        imgElement.src = URL.createObjectURL(event.data);
    };

    // Log errors
    socket.onerror = function(error) {
        console.error('WebSocket error:', error);
    };    
//     let imageUpdateInterval;

// function updateImage() {
//     var img = document.getElementById('stream'); // Get the image element by its ID ('stream')
//     img.src = "{% url 'video_feed' %}"; // Set the 'src' attribute of the image to the URL of the video feed
// }

// function startImageUpdate() {
//     imageUpdateInterval = setInterval(updateImage, 100); // Update image every 100 milliseconds
// }

// function stopImageUpdate() {
//     clearInterval(imageUpdateInterval); // Clear the interval timer to stop updating the image
// }

// // Call the startImageUpdate function to begin updating the image
// startImageUpdate();

// Update every 100 milliseconds
const taskId = '{{ task_id }}';

function checkStatus() {
    fetch(`/get_status/${taskId}/`)
        .then(response => response.json())
        .then(data => {
            if (data.status === 'Processing') {
                setTimeout(checkStatus, 5000); // Check again after 5 seconds
            } else {
                let resultMessage;
                if (data.status === '0') {
                    resultMessage = 'Not Fatigued';

                } else if (data.status === '1') {
                    resultMessage = 'Fatigued';
                } else {
                    resultMessage = data.status; // Display any other status messages directly
                }
                document.getElementById('gaitResult').innerText = resultMessage;
                document.getElementById('workerResult').innerText = resultMessage;
                // document.getElementById('spinner1').style.display = 'none';
                // Stop updating the image once the result is received
                // stopImageUpdate();
            }
        })
        .catch(error => {
            document.getElementById('gaitResult').innerText = 'Error checking status';
            // document.getElementById('spinner1').style.display = 'none';
            setTimeout(checkStatus, 5000);   // REMOVE THIS ******************************************************** 
        });
}
setTimeout(checkStatus, 1000); // Initial check after 5 seconds
// Function to identify the worker
// function identifyWorker() {
//     fetch('{% url "identifyWorker" %}')
//         .then(response => response.json())
//         .then(data => {
//             if (data.workerName) {
//                 document.getElementById('workerId').innerText = data.workerId || 'N/A';
//                 document.getElementById('workerName').innerText = data.workerName;
//             } else {
//                 document.getElementById('workerId').innerText = 'N/A';
//                 document.getElementById('workerName').innerText = 'NOTDETECTED';
//             }
//             document.getElementById('spinner1').style.display = 'none';
//         })
//         .catch(error => {
//             console.error('Error identifying worker:', error);
//             document.getElementById('workerId').innerText = 'Error';
//             document.getElementById('workerName').innerText = 'Error';
//             document.getElementById('spinner1').style.display = 'none';
//         });
// }
// identifyWorker()

// Call the identifyWorker function when the document is ready
// document.addEventListener('DOMContentLoaded', identifyWorker);
const task1Id='{{ task1_id }}'
function checkIdentficationStatus(){
    fetch(`/get_identfication_status/${task1Id}/`)
        .then(response => response.json())
        .then(data => {
            if (data.status1 === 'Identfication-in-process') {
                setTimeout(checkIdentficationStatus, 5000); // Check again after 5 seconds
            } else {
                if (data.workerName) {
                document.getElementById('workerId').innerText = data.workerId || 'N/A';
                document.getElementById('workerName').innerText = data.workerName;
                // document.getElementById('workerResult').innerText = document.getElementById('gaitResult').innerText;
                document.getElementById('spinner1').style.display = 'none';
            
            } else {
                document.getElementById('workerId').innerText = 'N/A';
                document.getElementById('workerName').innerText = 'NOTDETECTED';
                document.getElementById('spinner1').style.display = 'none';
            }
            }
        })
        .catch(error => {
            document.getElementById('gaitResult').innerText = 'Error checking status';
            document.getElementById('spinner1').style.display = 'none';
        });

}
setTimeout(checkIdentficationStatus, 1000);



</script>


{% endblock %}