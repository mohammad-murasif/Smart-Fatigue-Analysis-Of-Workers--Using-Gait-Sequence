{% extends 'myApp/base.html' %}
{% block content%}
{% load static%}
<div id="carouselExampleIndicators" class="carousel slide" data-ride="carousel">
    <ol class="carousel-indicators">
        <li data-target="#carouselExampleIndicators" data-slide-to="0" class="active"></li>
        <li data-target="#carouselExampleIndicators" data-slide-to="1"></li>
        <li data-target="#carouselExampleIndicators" data-slide-to="2"></li>
    </ol>
    <div class="carousel-inner">
        <div class="carousel-item active">
            <img class="d-block w-100" src="{% static 'imgs/banner-recog.jpg'%}" alt="First slide">
        </div>
        <div class="carousel-item">
            <img class="d-block w-100" src="..." alt="Third slide">
        </div>
    </div>
    <a class="carousel-control-prev" href="#carouselExampleIndicators" role="button" data-slide="prev">
        <span class="carousel-control-prev-icon" aria-hidden="true"></span>
        <span class="sr-only">Previous</span>
    </a>
    <a class="carousel-control-next" href="#carouselExampleIndicators" role="button" data-slide="next">
        <span class="carousel-control-next-icon" aria-hidden="true"></span>
        <span class="sr-only">Next</span>
    </a>
</div>
<!-- Registration 2 - Bootstrap Brain Component -->



<div class="container">
    <div class="row">
        <div class="col-md-8  ">
            <div class="bg-white p-4 p-md-5 rounded shadow-sm w-100">
                <div class="row justify-content-center">
                    <div class="col-6">
                        <div class="mb-3">
                            <h2 class="h3">Worker Recognition Trainer</h2>
                        </div>
                    </div>
                </div>
                <form id="videoForm" enctype="multipart/form-data">
                    {% csrf_token %}
                    <div class="row gy-3 gy-md-4 overflow-hidden w-100 pb-6">
                        <div class="col-12">
                            <label for="worker.workerId" class="form-label">Worker <span
                                    class="text-danger">*</span></label>
                            <select class="form-select" aria-label="Default select example" id="workerId"
                                name="workerId">
                                <option selected>Select Worker</option>
                                {% for worker in workers %}
                                <option value="{{ worker.workerId }}">{{ worker.workerName }} {{ worker.workerId}} - {{
                                    worker.workerPhoneNo }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="col-12">
                            <label class="form-label" for="customFile">Video</label>
                            <input type="file" class="form-control" id="id_video" name="video" accept="video/*"
                                oninput="updateLab(this.value, 'regLab')" required />
                        </div>
                        <div class="col-12">
                            <div class="progress mb-3" style="display: none;">
                                <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar"
                                    style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                            </div>
                        </div>
                        <div class="col-12">
                            <div class="d-grid">
                                <button class="btn btn-lg btn-primary" type="submit" id="uploadbutton">Upload</button>
                                <h3 class="fs-6 fw-normal text-secondary mt-3">Note<sup style="color:red;font-size: 20px;">*</sup>: High quality video having different poses of face of a worker</h3>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div id="result" class="mt-3"></div>
                    </div>
                </form>

                <div class="row mt-1 pt-3" style="            display: flex;
                    justify-content: center;
                    align-items: center;">
                    <button type="button" class="btn  btn-success btn-block" id="trainButton">Train On Existing
                        Data</button>
                    <div id="message" class="mt-3"></div>
                </div>


            </div>
        </div>

        <div class="col-md-4 p-2 m-auto ">

            <img src="{% static 'imgs/sidepanel-img.jpeg' %}" alt="Side Image" class="w-100">
        </div>


    </div>
</div>

<!-- Include jQuery for easier DOM manipulation (optional) -->
<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script>
    document.getElementById('trainButton').addEventListener('click', function () {
        var button = this;
        var messageDiv = document.getElementById('message');
        messageDiv.innerHTML = 'Training in progress...';
        button.disabled = true;

        fetch('{% url "trainforkerfaces" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}',
            },
        })
            .then(response => response.json())
            .then(data => {
                messageDiv.innerHTML = data.message;
                button.disabled = false;

            })
            .catch(error => {
                messageDiv.innerHTML = 'An error occurred during training';
                console.error('Error:', error);

                button.disabled = false;
            });
    });
    $(document).ready(function () {
        $('#videoForm').submit(function (event) {
            event.preventDefault();
            var form = $(this)[0];
            var formData = new FormData(form);
            var uploadbutton = $('#uploadbutton');

            $.ajax({
                xhr: function () {
                    var xhr = new window.XMLHttpRequest();
                    xhr.upload.addEventListener("progress", function (evt) {
                        if (evt.lengthComputable) {
                            var percentComplete = evt.loaded / evt.total * 100;
                            $(".progress-bar").width(percentComplete + '%');
                            $(".progress-bar").attr('aria-valuenow', percentComplete);
                        }
                    }, false);
                    return xhr;
                },
                type: 'POST',
                url: '{% url "trainrecog" %}',
                data: formData,
                contentType: false,
                processData: false,
                success: function (response) {
                    $('#result').text(response.results);

                },
                error: function (xhr, status, error) {
                    $('#result').text('Error processing video: ' + error);
                },
                complete: function () {
                    $(".progress").hide();
                }
            });

            $(".progress").show();
        });
    });







</script>

{% endblock %}